<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Hagrid – Clean UI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif;
      margin: 0;
      background: #fafafa;
      padding: 12px;
    }

    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    h2 {
      margin: 0 0 12px 0;
      font-size: 15px;
      font-weight: 600;
    }

    .label {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .value {
      background: #f2f2f5;
      padding: 8px;
      border-radius: 4px;
      font-size: 13px;
      white-space: pre-wrap;
    }

    .textarea {
      width: 100%;
      min-height: 120px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 13px;
      box-sizing: border-box;
    }

    .button {
      display: inline-block;
      padding: 8px 12px;
      background: #2f60d8;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      font-size: 13px;
      margin-top: 8px;
    }

    .button-secondary {
      background: #e5e5ea;
      color: #111;
      margin-left: 6px;
    }

    ul {
      padding-left: 16px;
      font-size: 13px;
      margin: 6px 0;
    }
  </style>
</head>

<body>
  <!-- SECTION 1 — DEADLINE MONITORS -->
  <div class="panel" id="deadline-panel">
    <h2>Tour Deadline Monitor</h2>

    <div class="label">Tour Date</div>
    <div class="value" id="tour-date">Loading...</div>

    <div class="label" style="margin-top:12px;">Deadlines</div>
    <ul id="deadline-list"><li>Loading…</li></ul>

    <div class="label" style="margin-top:12px;">Alerts</div>
    <div class="value" id="deadline-alerts">–</div>
  </div>

  <!-- SECTION 2 — GENERATE REPLY -->
  <div class="panel" id="reply-panel">
    <h2>Auto-Reply Maker</h2>

    <div class="label">Suggested Macro</div>
    <div class="value" id="macro-output">–</div>

    <div class="label" style="margin-top:12px;">Internal Note (Draft)</div>
    <textarea class="textarea" id="reply-text" placeholder="Click Generate Reply"></textarea>

    <button class="button" id="btn-generate">Generate Reply</button>
    <button class="button button-secondary" id="btn-insert">Insert into Internal Note</button>
  </div>

  <!-- SECTION 3 — DSS AUDITOR -->
  <div class="panel" id="dss-panel">
    <h2>DSS Refund Auditor</h2>

    <div class="label">Ticket Summary</div>
    <div class="value" id="ticket-summary">Loading...</div>

    <div class="label" style="margin-top:12px;">Audit Result</div>
    <div class="value" id="audit-result">–</div>

    <button class="button" id="btn-audit">Run Audit</button>
    <button class="button button-secondary" id="btn-save">Save to Sheets</button>
  </div>

  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <script>
    const client = ZAFClient.init();

    /* ---------------------------
       Minimal Deadline Monitor
    ----------------------------*/
    async function refreshDeadline() {
      const custom = await client.get('ticket.customField:custom_field_tour_date');
      const raw = custom['ticket.customField:custom_field_tour_date'];
      const tourDate = raw ? new Date(raw) : null;

      document.getElementById('tour-date').textContent = raw || 'Not set';

      if (!tourDate) {
        document.getElementById('deadline-list').innerHTML = '<li>No tour date</li>';
        return;
      }

      const cuts = [
        { label: '72 hours before', t: new Date(tourDate - 72 * 3600000) },
        { label: '24 hours before', t: new Date(tourDate - 24 * 3600000) },
        { label: '2 hours before',  t: new Date(tourDate - 2  * 3600000) }
      ];

      const now = new Date();
      const list = document.getElementById('deadline-list');
      list.innerHTML = '';

      let overdue = 0;

      cuts.forEach(c => {
        const diff = c.t - now;
        if (diff < 0) overdue++;

        const li = document.createElement('li');
        li.textContent = `${c.label} — ${c.t.toISOString().slice(0,16).replace('T',' ')} (${diff < 0 ? 'Passed' : 'Upcoming'})`;
        list.appendChild(li);
      });

      document.getElementById('deadline-alerts').textContent =
        overdue ? `${overdue} deadlines passed` : 'All deadlines upcoming';
    }

    client.on('ticket.custom_field_changed', refreshDeadline);
    refreshDeadline();


    /* ---------------------------
         Minimal Reply Generator
    ----------------------------*/
    async function generateReply() {
      document.getElementById('macro-output').textContent = 'Thinking…';

      const ticket = (await client.get('ticket')).ticket;
      const desc = ticket.description;

      // Simple placeholder – your LLM API call goes here
      const fakeReply = {
        macro: "General Update Macro",
        text: `Hi team, drafted reply based on: ${desc.slice(0,120)}…`
      };

      document.getElementById('macro-output').textContent = fakeReply.macro;
      document.getElementById('reply-text').value = fakeReply.text;
    }

    async function insertReply() {
      const text = document.getElementById('reply-text').value;
      await client.set('comment', { text, public: false });
      alert('Inserted into internal note');
    }

    document.getElementById('btn-generate').onclick = generateReply;
    document.getElementById('btn-insert').onclick = insertReply;


    /* ---------------------------
             Minimal DSS Audit
    ----------------------------*/
    let lastAudit = null;

    async function runAudit() {
      const ticket = (await client.get('ticket')).ticket;
      document.getElementById('ticket-summary').textContent =
        `#${ticket.id}\n${ticket.subject}\n\n${ticket.description}`;

      // Placeholder – your LLM call here
      lastAudit = {
        decision: "APPROVE",
        reason: "Matches rule: customer notified within allowed window."
      };

      document.getElementById('audit-result').textContent =
        `${lastAudit.decision}\n${lastAudit.reason}`;
    }

    async function saveAudit() {
      if (!lastAudit) return alert('No audit to save');

      alert('Saved to Sheets (stub)');
    }

    document.getElementById('btn-audit').onclick = runAudit;
    document.getElementById('btn-save').onclick = saveAudit;
  </script>
</body>
</html>
