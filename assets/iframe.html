<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Ticket Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Zendesk SDK -->
<script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

<!-- Inter Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #0066cc;
    --warning: #d97706;
    --error: #dc2626;
    --bg: #ffffff;
    --surface: #f9fafb;
    --border: #e5e7eb;
    --text: #111827;
    --text-light: #6b7280;
    --radius: 12px;
    --shadow: 0 2px 6px rgba(0,0,0,0.06);
  }

  body {
    margin: 0;
    background: var(--surface);
    font-family: Inter, sans-serif;
    font-size: 14px;
    color: var(--text);
  }

  .container {
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: 24px;
  }

  .card {
    background: var(--bg);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    padding: 20px;
    margin-bottom: 28px;
  }

  h2 {
    margin: 0 0 14px 0;
    font-size: 18px;
    font-weight: 600;
  }

  textarea {
    width: 100%;
    min-height: 130px;
    padding: 10px;
    font-size: 14px;
    border-radius: 8px;
    border: 1px solid var(--border);
  }

  button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-right: 8px;
    font-weight: 500;
  }

  .btn-primary { background: var(--primary); color: #fff; }
  .btn-secondary { background: #e5e7eb; color: #111; }

  .info { margin: 4px 0; color: var(--text-light); }

  .note {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
  }

  .note-warn { background: #fff7e6; border-left: 4px solid var(--warning); }
  .note-error { background: #feeceb; border-left: 4px solid var(--error); }
</style>
</head>


<body>
<div class="container">

  <!-- DEADLINE MONITOR -->
  <div class="card">
    <h2>Tour Deadline Monitor</h2>
    <div id="deadline-output">Loading…</div>
  </div>

  <!-- REPLY GENERATOR -->
  <div class="card">
    <h2>Generate Reply</h2>
    <textarea id="reply-text" placeholder="Click Generate Reply"></textarea>
    <button class="btn-primary" id="btn-generate-reply">Generate Reply</button>
    <button class="btn-secondary" id="btn-insert-reply">Insert Internal Note</button>
    <div id="reply-error" style="margin-top:8px;color:var(--error)"></div>
  </div>

  <!-- DSS AUDIT -->
  <div class="card">
    <h2>DSS Refund Audit</h2>
    <div id="audit-output"></div>
    <button class="btn-primary" id="btn-run-audit">Run Audit</button>
    <button class="btn-secondary" id="btn-save-audit">Send to Sheets</button>
    <div id="audit-error" style="margin-top:8px;color:var(--error)"></div>
  </div>

</div>


<script>
/***********************************************************
 * CONFIG
 ***********************************************************/
const client = ZAFClient.init();
client.invoke("resize", { width: "100%", height: "1000px" });

// CHANGE THIS ONLY:
const APPS_SCRIPT_URL = "YOUR_APPS_SCRIPT_URL_HERE";


/***********************************************************
 * CALL BACKEND (Apps Script)
 ***********************************************************/
async function backend(action, payload = {}) {
  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ action, ...payload })
  });
  return await res.json();
}


/***********************************************************
 * SAFE GEMINI TEXT EXTRACTOR
 ***********************************************************/
function extractGeminiText(resp) {
  try {
    return resp?.result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "";
  } catch {
    return "";
  }
}


/***********************************************************
 * 1️⃣ DEADLINE MONITOR
 ***********************************************************/
async function loadDeadline() {
  const out = document.getElementById("deadline-output");

  // Fetch ALL custom fields correctly
  const cf = (await client.get("ticket.customFields"))["ticket.customFields"];

  const city        = cf["custom_field_360021522151"];
  const tourDate    = cf["custom_field_360024323231"];
  const startTime   = cf["custom_field_360021522271"];
  const completion  = cf["custom_field_360021520271"];

  if (completion) {
    out.innerHTML = "<b>Completion Type already set.</b><br>No action required.";
    return;
  }

  if (!city || !tourDate || !startTime) {
    out.innerHTML = "City / Tour Date / Start Time missing.";
    return;
  }

  // 1) Resolve timezone via Gemini
  const tzResp = await backend("gemini", {
    prompt: `City or place: "${city}". Return ONLY the correct IANA timezone.`
  });

  let timezone = extractGeminiText(tzResp) || "Asia/Kolkata";

  // 2) Compose datetime
  const full = `${tourDate} ${startTime}`;
  const tourDT = new Date(full);

  // 3) Convert NOW → city timezone
  const nowCity = new Date(
    new Date().toLocaleString("en-US", { timeZone: timezone })
  );

  const diffMs = tourDT - nowCity;
  const diffMin = Math.floor(diffMs / 60000);

  let html = `
    <div class="info"><b>City:</b> ${city}</div>
    <div class="info"><b>Timezone:</b> ${timezone}</div>
    <div class="info"><b>Tour Date:</b> ${tourDate}</div>
    <div class="info"><b>Start Time:</b> ${startTime}</div>
    <div class="info"><b>Minutes to fulfill:</b> ${diffMin}</div>
  `;

  // No action required
  if (diffMin > 15) {
    out.innerHTML = html + `<div class="note">No action required.</div>`;
    return;
  }

  // Prevent duplicate internal notes
  const comments = (await client.get("ticket.comments"))["ticket.comments"];
  const alreadyAdded = comments.some(c => c.body.includes("experience time"));
  if (alreadyAdded) {
    out.innerHTML = html + `<div class="note">Internal note already added.</div>`;
    return;
  }

  const ticketId = (await client.get("ticket.id"))["ticket.id"];

  // <15 min (but not passed)
  if (diffMin > 0 && diffMin <= 15) {
    await addNote(ticketId, `
The experience time is less than 15 minutes away.
It will expire at ${startTime} (${timezone}).
Please take the necessary action.
    `.trim());

    out.innerHTML = html +
      `<div class="note note-warn">⚠️ Less than 15 minutes remaining.</div>`;
    return;
  }

  // Passed case
  if (diffMin < 0) {
    await addNote(ticketId, `
The experience time has already passed.
Please take the necessary action.
    `.trim());

    out.innerHTML = html +
      `<div class="note note-error">⛔ Experience time has passed.</div>`;
    return;
  }
}

async function addNote(ticketId, text) {
  return client.request({
    url: `/api/v2/tickets/${ticketId}.json`,
    method: "PUT",
    contentType: "application/json",
    data: JSON.stringify({
      ticket: { comment: { body: text, public: false }}
    })
  });
}


/***********************************************************
 * 2️⃣ GENERATE REPLY
 ***********************************************************/
document.getElementById("btn-generate-reply").onclick = async () => {
  const out = document.getElementById("reply-text");
  const err = document.getElementById("reply-error");
  err.textContent = "";

  const ticket = (await client.get("ticket")).ticket;

  const prompt = `
Write an internal note reply for this customer inquiry:

${ticket.description}

Return ONLY the reply text.
  `.trim();

  const resp = await backend("gemini", { prompt });
  out.value = extractGeminiText(resp) || "No reply generated.";
};

document.getElementById("btn-insert-reply").onclick = async () => {
  const text = document.getElementById("reply-text").value;
  if (!text) return;
  await client.set("comment", { text, public:false });
};


/***********************************************************
 * 3️⃣ DSS AUDIT
 ***********************************************************/
document.getElementById("btn-run-audit").onclick = async () => {
  const out = document.getElementById("audit-output");

  const ticket = (await client.get("ticket")).ticket;

  const prompt = `
Analyze this customer’s refund request and return JSON like:
{
"decision":"APPROVE/REJECT",
"reason":"..."
}

Ticket:
${ticket.description}
  `.trim();

  const resp = await backend("gemini", { prompt });
  const text = extractGeminiText(resp);

  out.innerHTML = `<pre>${text}</pre>`;
  window._audit = text;
};

document.getElementById("btn-save-audit").onclick = async () => {
  const err = document.getElementById("audit-error");
  if (!window._audit) {
    err.textContent = "Run audit first.";
    return;
  }

  await backend("saveAudit", {
    sheetName:"VS output",
    row:[
      "BookingID",
      new Date().toISOString(),
      window._audit,
      "", "", "", "", "", "", "", "", ""
    ]
  });

  err.style.color = "green";
  err.textContent = "Saved to Google Sheets.";
};


/***********************************************************
 * INIT
 ***********************************************************/
loadDeadline();
</script>

</body>
</html>
