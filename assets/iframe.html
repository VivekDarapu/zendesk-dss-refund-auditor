<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Hagrid App â€“ Direct Key Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, sans-serif;
      margin: 0;
      background: #fafafa;
      padding: 12px;
    }
    .panel {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }
    h2 {
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
    }
    .label {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .value {
      background: #f2f2f5;
      padding: 8px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-size: 13px;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
    }
    .button {
      padding: 8px 12px;
      background: #2f60d8;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      border: none;
      margin-top: 8px;
      font-size: 13px;
    }
    .button-secondary {
      background: #e5e5ea;
      color: #111;
      margin-left: 6px;
    }
    ul {
      padding-left: 16px;
    }
  </style>
</head>

<body>

  <!-- DEADLINE MONITOR -->
  <div class="panel">
    <h2>Tour Deadline Monitor</h2>
    <div class="label">Tour Date</div>
    <div class="value" id="tour-date">Loading...</div>

    <div class="label" style="margin-top:12px;">Deadlines</div>
    <ul id="deadline-list"><li>Loadingâ€¦</li></ul>

    <div class="label" style="margin-top:12px;">Alerts</div>
    <div class="value" id="deadline-alerts">â€“</div>
  </div>

  <!-- AUTO REPLY MAKER -->
  <div class="panel">
    <h2>Auto Reply Maker</h2>

    <div class="label">Suggested Macro</div>
    <div class="value" id="macro-output">â€“</div>

    <div class="label" style="margin-top:12px;">Internal Note Draft</div>
    <textarea id="reply-text" placeholder="Click Generate Reply"></textarea>

    <button class="button" id="btn-generate">Generate Reply</button>
    <button class="button button-secondary" id="btn-insert">Insert</button>
  </div>

  <!-- DSS AUDITOR -->
  <div class="panel">
    <h2>DSS Refund Auditor</h2>

    <div class="label">Ticket Summary</div>
    <div class="value" id="ticket-summary">Loadingâ€¦</div>

    <div class="label" style="margin-top:12px;">Audit Result</div>
    <div class="value" id="audit-result">â€“</div>

    <button class="button" id="btn-audit">Run Audit</button>
    <button class="button button-secondary" id="btn-save">Save Audit</button>
  </div>


  <!-- ZENDESK SDK -->
  <script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

  <script>
    const client = ZAFClient.init();

    /* -------------------------------------------------------
       ðŸ” DIRECTLY EMBED YOUR KEYS HERE
    --------------------------------------------------------*/
    const CONFIG = {
      HF_API_KEY: "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",
      HF_MODEL: "meta-llama/Llama-3-8b-Instruct",

      GEMINI_API_KEY: "AIzaSyDok2AEBmHh4hFYpbF6SHrHCkxGiD1ssTk",
      GEMINI_MODEL: "gemini-1.5-flash",

      SHEETS_PROXY: "https://script.google.com/macros/s/AKfycbx98b4iwSD0SklSFfAROjWISTxN954BUGcZK6NxhHA_rc8aHJeI63zHlJ5hg_2Z2BBPuQ/exec"
    };


    /* -------------------------------------------------------
       DEADLINE MONITOR
    --------------------------------------------------------*/
    client.on("app.registered", refreshDeadline);

    async function refreshDeadline() {
      const raw = (await client.get('ticket.customField:custom_field_tour_date'))
        ['ticket.customField:custom_field_tour_date'];

      document.getElementById('tour-date').textContent = raw || "Not set";

      if (!raw) return;

      const tourDate = new Date(raw);
      const now = new Date();

      const deadlines = [
        { label: "72 hours before", t: new Date(tourDate - 72*3600000) },
        { label: "24 hours before", t: new Date(tourDate - 24*3600000) },
        { label: "2 hours before",  t: new Date(tourDate - 2*3600000) }
      ];

      const list = document.getElementById('deadline-list');
      list.innerHTML = "";
      let overdue = 0;

      deadlines.forEach(d => {
        const diff = d.t - now;
        if (diff < 0) overdue++;

        const li = document.createElement("li");
        li.textContent =
          `${d.label} â€” ${d.t.toISOString().slice(0,16)} (${diff < 0 ? "Passed" : "Upcoming"})`;
        list.appendChild(li);
      });

      document.getElementById('deadline-alerts').textContent =
        overdue ? `${overdue} missed` : "All upcoming";
    }


    /* -------------------------------------------------------
       LLM CALLS (HF + GEMINI FALLBACK)
    --------------------------------------------------------*/
    async function callHF(prompt) {
      const res = await fetch(
        `https://api-inference.huggingface.co/models/${CONFIG.HF_MODEL}`,
        {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${CONFIG.HF_API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ inputs: prompt })
        }
      );
      const out = await res.json();
      return out[0]?.generated_text || JSON.stringify(out);
    }

    async function callGemini(prompt) {
      const res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.GEMINI_MODEL}:generateContent?key=${CONFIG.GEMINI_API_KEY}`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        }
      );
      const out = await res.json();
      return out?.candidates?.[0]?.content?.parts?.[0]?.text || "";
    }


    /* -------------------------------------------------------
       AUTO REPLY MAKER
    --------------------------------------------------------*/
    document.getElementById("btn-generate").onclick = generateReply;
    document.getElementById("btn-insert").onclick = insertReply;

    async function generateReply() {
      document.getElementById('macro-output').textContent = "Thinkingâ€¦";

      const t = (await client.get('ticket')).ticket;

      const prompt = `
Provide an internal note + best macro.
Ticket:
${t.description}
Return ONLY JSON:
{ "macro": "", "reply": "" }
      `;

      let out;
      try { out = await callHF(prompt); }
      catch { out = await callGemini(prompt); }

      let parsed = {};
      try { parsed = JSON.parse(out.match(/\{[\s\S]*\}/)[0]); }
      catch { parsed = { macro: "General Macro", reply: out }; }

      document.getElementById('macro-output').textContent = parsed.macro;
      document.getElementById('reply-text').value = parsed.reply;
    }

    async function insertReply() {
      await client.set("comment", {
        text: document.getElementById("reply-text").value,
        public: false
      });
      alert("Inserted into internal note");
    }


    /* -------------------------------------------------------
       DSS AUDITOR
    --------------------------------------------------------*/
    document.getElementById("btn-audit").onclick = runAudit;
    document.getElementById("btn-save").onclick = saveAudit;

    async function runAudit() {
      const ticket = (await client.get('ticket')).ticket;

      document.getElementById('ticket-summary').textContent =
        `#${ticket.id}\n${ticket.subject}\n\n${ticket.description}`;

      const prompt = `
Perform DSS audit. Return JSON:
{ "decision": "", "reason": "" }
      `;

      let out;
      try { out = await callHF(prompt); }
      catch { out = await callGemini(prompt); }

      let audit = {};
      try { audit = JSON.parse(out.match(/\{[\s\S]*\}/)[0]); }
      catch { audit = { decision: "UNKNOWN", reason: out }; }

      window._lastAudit = audit;

      document.getElementById('audit-result').textContent =
        `${audit.decision}\n${audit.reason}`;
    }

    async function saveAudit() {
      if (!window._lastAudit) return alert("Run audit first");

      await fetch(CONFIG.SHEETS_PROXY, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          sheetName: "VS output",
          row: [
            new Date().toISOString().slice(0,10),
            window._lastAudit.decision,
            window._lastAudit.reason
          ]
        })
      });

      alert("Saved to Sheets");
    }
  </script>

</body>
</html>
