<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>AI Ticket Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Zendesk SDK -->
<script src="https://static.zdassets.com/zendesk_app_framework_sdk/2.0/zaf_sdk.min.js"></script>

<!-- Inter font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #0066cc;
    --warning: #d97706;
    --error: #dc2626;
    --success: #059669;
    --bg: #ffffff;
    --surface: #f9fafb;
    --border: #e5e7eb;
    --text: #111827;
    --text-light: #6b7280;
    --radius: 12px;
    --shadow: 0 2px 6px rgba(0,0,0,0.06);
  }

  body {
    margin: 0;
    background: var(--surface);
    font-family: Inter, sans-serif;
    font-size: 14px;
    -webkit-font-smoothing: antialiased;
  }

  .container {
    max-width: 1180px;
    margin: 0 auto;
    padding: 24px;
  }

  .card {
    background: var(--bg);
    padding: 20px;
    margin-bottom: 28px;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }

  h2 {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
  }

  .info {
    margin: 6px 0;
    color: var(--text-light);
  }

  .note {
    margin-top: 12px;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
  }

  .note-warn {
    background: #fff7e6;
    border-left: 4px solid var(--warning);
  }

  .note-error {
    background: #feeceb;
    border-left: 4px solid var(--error);
  }

  textarea {
    width: 100%;
    min-height: 130px;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px;
    font-size: 14px;
  }

  button {
    padding: 10px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    margin-right: 8px;
    font-weight: 500;
    font-size: 14px;
  }

  .btn-primary {
    background: var(--primary);
    color: #fff;
  }

  .btn-secondary {
    background: #e5e7eb;
    color: #000;
  }
</style>
</head>


<body>
<div class="container">

  <!-- DEADLINE MONITOR -->
  <div class="card">
    <h2>Tour Deadline Monitor</h2>
    <div id="deadline-output">Loading…</div>
  </div>

  <!-- REPLY GENERATOR -->
  <div class="card">
    <h2>Generate Reply</h2>

    <textarea id="reply-box" placeholder="Click Generate Reply"></textarea>

    <button class="btn-primary" id="btn-reply">Generate Reply</button>
    <button class="btn-secondary" id="btn-insert-reply">Insert Internal Note</button>

    <div id="reply-error" style="margin-top:10px;color:var(--error)"></div>
  </div>

  <!-- DSS AUDIT -->
  <div class="card">
    <h2>DSS Refund Audit</h2>

    <div id="audit-output"></div>
    <button class="btn-primary" id="btn-audit">Run Audit</button>
    <button class="btn-secondary" id="btn-save-audit">Send to Sheets</button>

    <div id="audit-error" style="margin-top:10px;color:var(--error)"></div>
  </div>

</div>


<script>
/************************************************************
 * CONFIG
 ************************************************************/
const client = ZAFClient.init();
client.invoke('resize', { width: '100%', height: '900px' });

/* Replace with your deployed Google Apps Script Web App URL */
const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx98b4iwSD0SklSFfAROjWISTxN954BUGcZK6NxhHA_rc8aHJeI63zHlJ5hg_2Z2BBPuQ/exec";

/************************************************************
 * GENERIC BACKEND CALLER
 ************************************************************/
async function backend(action, payload = {}) {
  const body = JSON.stringify({ action, ...payload });

  const res = await fetch(APPS_SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body
  });

  return await res.json();
}

/************************************************************
 * 1️⃣ DEADLINE MONITOR
 ************************************************************/
async function loadDeadline() {
  const out = document.getElementById("deadline-output");

  const fields = await client.get([
    "ticket.customField:custom_field_360021522151", // City
    "ticket.customField:custom_field_360024323231", // Tour Date
    "ticket.customField:custom_field_360021522271", // Start Time
    "ticket.customField:custom_field_360021520271"  // Completion Type
  ]);

  const city = fields["ticket.customField:custom_field_360021522151"];
  const tourDate = fields["ticket.customField:custom_field_360024323231"];
  const startTime = fields["ticket.customField:custom_field_360021522271"];
  const completion = fields["ticket.customField:custom_field_360021520271"];

  if (completion) {
    out.innerHTML = "<b>Completion Type already set.</b><br>No action required.";
    return;
  }

  if (!city || !tourDate || !startTime) {
    out.innerHTML = "Missing City / Tour Date / Start Time fields";
    return;
  }

  // ① Determine timezone via Gemini
  const tzPrompt = `City or place: "${city}". Return ONLY the correct IANA timezone.`;
  const tzResult = await backend("gemini", { prompt: tzPrompt });

  let timezone = "Asia/Kolkata";
  try {
    timezone = tzResult?.result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Asia/Kolkata";
  } catch {}

  // ② Build full datetime
  const fullString = `${tourDate} ${startTime}`;
  const tourDT = new Date(fullString);

  // ③ Convert NOW → city time
  const nowInCity = new Date(
    new Date().toLocaleString("en-US", { timeZone: timezone })
  );

  const diffMs = tourDT - nowInCity;
  const diffMin = Math.floor(diffMs / 60000);

  let html = `
    <div class="info"><b>City:</b> ${city}</div>
    <div class="info"><b>Timezone:</b> ${timezone}</div>
    <div class="info"><b>Tour Date:</b> ${tourDate}</div>
    <div class="info"><b>Start Time:</b> ${startTime}</div>
    <div class="info"><b>Minutes to fulfill:</b> ${diffMin}</div>
  `;

  // No action required case
  if (diffMin > 15) {
    out.innerHTML = html + `<div class="note">No action required.</div>`;
    return;
  }

  // Internal note already added?
  const comments = await client.get("ticket.comments");
  const alreadyAdded = comments["ticket.comments"].some(c =>
    c.body.includes("experience time")
  );
  if (alreadyAdded) {
    out.innerHTML = html + `<div class="note">Internal note already added.</div>`;
    return;
  }

  // Get ticket ID
  const ticketId = (await client.get("ticket.id"))["ticket.id"];

  // CASE: 0 < diff ≤ 15
  if (diffMin > 0 && diffMin <= 15) {
    const note = `
The experience time is less than 15 minutes away.
It will expire at ${startTime} (${timezone}).
Please take the necessary action.
    `.trim();

    await addInternalNote(ticketId, note);

    out.innerHTML = html +
      `<div class="note note-warn">⚠️ Less than 15 minutes remaining.</div>`;
    return;
  }

  // CASE: diff < 0
  if (diffMin < 0) {
    const note = `
The experience time has already passed.
Please take the necessary action.
    `.trim();

    await addInternalNote(ticketId, note);

    out.innerHTML = html +
      `<div class="note note-error">⛔ Experience time has passed.</div>`;
    return;
  }
}

async function addInternalNote(ticketId, text) {
  return client.request({
    url: `/api/v2/tickets/${ticketId}.json`,
    method: "PUT",
    contentType: "application/json",
    data: JSON.stringify({
      ticket: {
        comment: { body: text, public: false }
      }
    })
  });
}




/************************************************************
 * 2️⃣ GENERATE REPLY
 ************************************************************/
document.getElementById("btn-reply").onclick = async () => {
  const out = document.getElementById("reply-box");
  const err = document.getElementById("reply-error");
  err.textContent = "";

  const ticket = (await client.get("ticket")).ticket;
  const prompt = `
You are a Zendesk agent. Based on this ticket description, write a helpful internal note.

Ticket:
${ticket.description}

Return ONLY the suggested reply text.
  `.trim();

  const resp = await backend("gemini", { prompt });

  try {
    const text =
      resp?.result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

    out.value = text || "No reply generated.";
  } catch {
    err.textContent = "Error generating reply.";
  }
};

document.getElementById("btn-insert-reply").onclick = async () => {
  const val = document.getElementById("reply-box").value;
  if (!val) return;

  await client.set("comment", { text: val, public: false });
};



/************************************************************
 * 3️⃣ DSS AUDIT
 ************************************************************/
document.getElementById("btn-audit").onclick = async () => {
  const out = document.getElementById("audit-output");

  out.innerHTML = "<b>Running audit…</b>";

  const ticket = (await client.get("ticket")).ticket;

  // You can customize this prompt
  const prompt = `
Analyze this customer request for a refund.

Ticket:
${ticket.description}

Return JSON:
{
"decision":"APPROVE/REJECT",
"reason":"text"
}
  `.trim();

  const resp = await backend("gemini", { prompt });

  const text =
    resp?.result?.candidates?.[0]?.content?.parts?.[0]?.text ?? "{}";

  out.innerHTML = `<pre>${text}</pre>`;

  window._audit = text; // store
};


document.getElementById("btn-save-audit").onclick = async () => {
  const out = document.getElementById("audit-error");

  if (!window._audit) {
    out.textContent = "Run audit first.";
    return;
  }

  await backend("saveAudit", {
    sheetName: "VS output",
    row: [
      Date.now(), new Date().toISOString(),
      window._audit, "", "", "", "", "", "", "", "", ""
    ]
  });

  out.textContent = "Saved.";
};


/************************************************************
 * INITIALIZE
 ************************************************************/
loadDeadline();
</script>

</body>
</html>
